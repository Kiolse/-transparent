<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Transparent Composer</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  @layer base {
    :root {
      --background: 0 0% 100%;
      --foreground: 0 0% 0%;
      --card: 0 0% 100%;
      --card-foreground: 0 0% 0%;
      --primary: 0 0% 0%;
      --primary-foreground: 0 0% 100%;
      --secondary: 0 0% 96%;
      --secondary-foreground: 0 0% 0%;
      --muted: 0 0% 96%;
      --muted-foreground: 0 0% 45%;
      --accent: 0 0% 96%;
      --accent-foreground: 0 0% 0%;
      --border: 0 0% 90%;
      --input: 0 0% 90%;
      --ring: 0 0% 0%;
      --radius: 0.5rem;
    }
  }

  * {
    border-color: hsl(var(--border));
  }

  body {
    background-color: hsl(var(--background));
    color: hsl(var(--foreground));
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Inter", Arial, "PingFang SC", "Microsoft YaHei", sans-serif;
  }

  /* 极简 Button */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s;
    outline: none;
    cursor: pointer;
    border: 1px solid hsl(var(--border));
    background-color: hsl(var(--background));
    color: hsl(var(--foreground));
    padding: 0.5rem 1rem;
    height: 2.25rem;
  }

  .btn:hover {
    background-color: hsl(var(--accent));
  }

  .btn-primary {
    background-color: hsl(var(--primary));
    color: hsl(var(--primary-foreground));
    border-color: hsl(var(--primary));
  }

  .btn-primary:hover {
    background-color: hsl(var(--primary) / 0.8);
  }

  /* 极简 Input */
  .input {
    width: 100%;
    border-radius: 0.375rem;
    border: 1px solid hsl(var(--input));
    background-color: hsl(var(--background));
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    transition: all 0.2s;
    outline: none;
    height: 2.25rem;
  }

  .input:focus {
    outline: none;
    box-shadow: 0 0 0 2px hsl(var(--foreground) / 0.1);
    border-color: hsl(var(--foreground));
  }

  /* 极简 Select */
  .select {
    width: 100%;
    border-radius: 0.375rem;
    border: 1px solid hsl(var(--input));
    background-color: hsl(var(--background));
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    transition: all 0.2s;
    outline: none;
    height: 2.25rem;
  }

  .select:focus {
    outline: none;
    box-shadow: 0 0 0 2px hsl(var(--foreground) / 0.1);
    border-color: hsl(var(--foreground));
  }

  /* 极简 Label */
  .label {
    font-size: 0.75rem;
    font-weight: 500;
    color: hsl(var(--muted-foreground));
    margin-bottom: 0.375rem;
    display: block;
  }

  /* 极简 Tabs */
  .tabs {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.375rem;
    background-color: hsl(var(--muted));
    padding: 0.125rem;
    width: 100%;
  }

  .tabs-trigger {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
    border-radius: 0.25rem;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s;
    cursor: pointer;
    border: none;
    background-color: transparent;
    color: hsl(var(--muted-foreground));
    outline: none;
    flex: 1;
  }

  .tabs-trigger[data-state="active"] {
    background-color: hsl(var(--background));
    color: hsl(var(--foreground));
  }

  .tabs-trigger:hover {
    color: hsl(var(--foreground));
  }

  /* Range Slider */
  .range {
    width: 100%;
    height: 0.375rem;
    border-radius: 9999px;
    background-color: hsl(var(--muted));
    outline: none;
    -webkit-appearance: none;
    appearance: none;
  }

  .range::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 1rem;
    height: 1rem;
    border-radius: 9999px;
    background-color: hsl(var(--foreground));
    cursor: pointer;
  }

  .range::-moz-range-thumb {
    width: 1rem;
    height: 1rem;
    border-radius: 9999px;
    background-color: hsl(var(--foreground));
    cursor: pointer;
    border: none;
  }

  /* Color Picker */
  .color-picker {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 0.375rem;
    border: 1px solid hsl(var(--border));
    cursor: pointer;
    overflow: hidden;
  }

  .color-picker input[type="color"] {
    width: 100%;
    height: 100%;
    border: none;
    padding: 0;
    margin: 0;
    cursor: pointer;
    -webkit-appearance: none;
    appearance: none;
  }

  .color-picker input[type="color"]::-webkit-color-swatch-wrapper {
    padding: 0;
  }

  .color-picker input[type="color"]::-webkit-color-swatch {
    border: none;
  }

  /* 极简 Preview Area */
  .preview {
    position: relative;
    width: 100%;
    aspect-ratio: 4 / 3;
    border-radius: 0.5rem;
    border: 2px solid hsl(var(--border));
    background-color: hsl(var(--muted) / 0.3);
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: border-color 0.2s, background-color 0.2s;
  }

  .preview.dragover {
    border-color: hsl(var(--foreground));
    background-color: hsl(var(--muted));
  }

  canvas {
    width: 100%;
    height: 100%;
    display: block;
  }

  .hint {
    position: absolute;
    right: 0.75rem;
    bottom: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    background-color: hsl(var(--background) / 0.9);
    font-size: 0.75rem;
    color: hsl(var(--muted-foreground));
    pointer-events: none;
  }

  .center-note {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    padding: 1rem 1.5rem;
    border-radius: 0.5rem;
    background-color: hsl(var(--background));
    color: hsl(var(--muted-foreground));
    font-size: 0.875rem;
    text-align: center;
    pointer-events: none;
    border: 1px solid hsl(var(--border));
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
  }

  .center-note .btn {
    pointer-events: auto;
  }

  input[type="file"] {
    display: none;
  }
</style>
</head>
<body class="min-h-screen bg-white py-8">
  <div class="w-[40%] mx-auto flex flex-col gap-6">
    <!-- 极简 Header -->
    <header class="text-center">
      <h1 class="text-xl font-semibold text-black mb-1">Transparent Composer</h1>
      <span id="info" class="text-xs text-gray-500">拖拽/粘贴/选择图片开始</span>
  </header>

    <!-- 预览区域 - 4:3比例 -->
    <div class="p-4">
        <div id="dropZone" class="preview" title="将图片文件拖拽到此处，或按 Ctrl/⌘+V 粘贴">
        <div class="w-full h-full flex items-center justify-center">
              <canvas id="canvas"></canvas>
            </div>
        <div id="centerHint" class="center-note">
          <label for="file" class="btn btn-primary cursor-pointer w-full">
            选择图片
          </label>
          <span class="block w-full text-center">拖拽图片到此处，或 Ctrl/⌘+V 粘贴</span>
          <div class="text-xs text-gray-400 w-full text-center">请选择透明的PNG图片</div>
          <input id="file" type="file" accept="image/*" />
        </div>
        <div id="sizeHint" class="hint">—</div>
      </div>
          </div>

    <!-- 控制区域 - 下方 -->
    <div class="border-t border-gray-200 px-4 py-6 space-y-6">

      <!-- 背景模式 -->
          <div>
        <label class="label">背景模式</label>
        <div class="tabs" role="tablist" aria-label="背景模式">
          <button id="modeChecker" class="tabs-trigger" data-state="active" role="tab" aria-selected="true">棋盘格</button>
          <button id="modeWhite" class="tabs-trigger" data-state="inactive" role="tab" aria-selected="false">纯白</button>
          <button id="modeBlack" class="tabs-trigger" data-state="inactive" role="tab" aria-selected="false">纯黑</button>
            </div>
          </div>

      <!-- 棋盘格控制 -->
      <div id="checkerGroup" class="space-y-4">
        <div>
          <label class="label">棋盘格颜色</label>
          <div class="flex gap-3">
            <div class="color-picker">
              <input id="cLight" type="color" value="#ffffff" />
            </div>
            <div class="color-picker">
              <input id="cDark" type="color" value="#f6f6f6" />
            </div>
          </div>
        </div>
          <div>
          <div class="flex items-center justify-between mb-2">
            <label class="label mb-0">格子大小</label>
            <span id="tileLabel" class="text-xs text-gray-400">16px</span>
          </div>
          <input id="tileSize" class="range" type="range" min="4" max="64" step="1" value="16" />
            </div>
          </div>

      <!-- 操作按钮 -->
      <div class="grid grid-cols-2 gap-3">
        <button id="copy" class="btn h-9">复制</button>
        <button id="download" class="btn btn-primary h-9">下载</button>
      </div>
    </div>
  </div>

<script>
  // Elements
  const canvas = document.getElementById('canvas');
  const info = document.getElementById('info');
  const centerHint = document.getElementById('centerHint');
  const sizeHint = document.getElementById('sizeHint');
  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('file');

  // Background mode buttons
  const modeCheckerBtn = document.getElementById('modeChecker');
  const modeWhiteBtn   = document.getElementById('modeWhite');
  const modeBlackBtn   = document.getElementById('modeBlack');
  const checkerGroup   = document.getElementById('checkerGroup');

  // Checker controls
  const cLight = document.getElementById('cLight');
  const cDark  = document.getElementById('cDark');
  const tileSize = document.getElementById('tileSize');
  const tileLabel = document.getElementById('tileLabel');

  // Export controls
  const btnDownload = document.getElementById('download');
  const btnCopy = document.getElementById('copy');

  const BG_MODES = { CHECKER:'checker', WHITE:'white', BLACK:'black' };

  const state = {
    img: null, w: 0, h: 0,
    bgMode: BG_MODES.CHECKER,
    light: '#ffffff',
    dark: '#f6f6f6',
    size: 16
  };

  function setCanvasToPreviewSize(){
    const preview = dropZone;
    const rect = preview.getBoundingClientRect();
    canvas.width = Math.max(1, Math.round(rect.width));
    canvas.height = Math.max(1, Math.round(rect.height));
  }

  function drawChecker(ctx, w, h, size, c1, c2){
    const tile = document.createElement('canvas');
    tile.width = size*2; tile.height = size*2;
    const tctx = tile.getContext('2d');
    tctx.fillStyle = c1; tctx.fillRect(0,0,tile.width,tile.height);
    tctx.fillStyle = c2;
    tctx.fillRect(0,0,size,size);
    tctx.fillRect(size,size,size,size);
    const pattern = ctx.createPattern(tile, 'repeat');
    ctx.save(); ctx.fillStyle = pattern; ctx.fillRect(0,0,w,h); ctx.restore();
  }

  function render(){
    setCanvasToPreviewSize();
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // Background layer - 总是撑满整个canvas
    if (state.bgMode === BG_MODES.CHECKER){
      drawChecker(ctx, canvas.width, canvas.height, state.size, state.light, state.dark);
    }else if (state.bgMode === BG_MODES.WHITE){
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0,0,canvas.width,canvas.height);
    }else if (state.bgMode === BG_MODES.BLACK){
      ctx.fillStyle = '#000000';
      ctx.fillRect(0,0,canvas.width,canvas.height);
    }

    // Image layer - 按比例缩放以适应canvas
    if (state.img){
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
      
      // 计算图片在canvas中的显示尺寸（保持比例）
      const imgW = state.img.naturalWidth || state.img.width;
      const imgH = state.img.naturalHeight || state.img.height;
      const canvasW = canvas.width;
      const canvasH = canvas.height;
      
      const scale = Math.min(canvasW / imgW, canvasH / imgH);
      const displayW = imgW * scale;
      const displayH = imgH * scale;
      const x = (canvasW - displayW) / 2;
      const y = (canvasH - displayH) / 2;
      
      ctx.drawImage(state.img, x, y, displayW, displayH);
      info.textContent = `图片 ${imgW}×${imgH}px | 预览 ${canvas.width}×${canvas.height}px`;
      sizeHint.textContent = `${imgW} × ${imgH}`;
      centerHint.style.display = 'none';
    }else{
      info.textContent = '拖拽/粘贴/选择图片开始';
      sizeHint.textContent = '—';
      centerHint.style.display = 'block';
    }

    // Toggle checker control visibility
    checkerGroup.style.display = state.bgMode === BG_MODES.CHECKER ? 'block' : 'none';
  }

  function loadImageFromFile(file){
    return new Promise((resolve, reject)=>{
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = ()=>{ URL.revokeObjectURL(url); resolve(img); };
      img.onerror = e=>{ URL.revokeObjectURL(url); reject(e); };
      img.src = url;
    });
  }

  async function handleFile(file){
    if (!file) return;
    if (!file.type.startsWith('image/')){ alert('请添加图片文件'); return; }
    try{
      const img = await loadImageFromFile(file);
      state.img = img;
      state.w = img.naturalWidth || img.width;
      state.h = img.naturalHeight || img.height;
      render();
    }catch(e){
      alert('加载失败：' + (e?.message || e));
    }
  }

  async function handleBlobOrFile(blob){
    const file = blob instanceof File ? blob : new File([blob], 'pasted.png', {type: blob.type || 'image/png'});
    await handleFile(file);
  }

  function exportBlob({format='png', quality=0.95}={}){
    const mime = format==='png' ? 'image/png' : format==='jpeg' ? 'image/jpeg' : 'image/webp';
    return new Promise(resolve=> canvas.toBlob(b=>resolve(b), mime, quality));
  }

  // File chooser
  fileInput.addEventListener('change', e=>{
    const f = e.target.files?.[0];
    handleFile(f).finally(()=> fileInput.value = '');
  });

  // Drag & drop
  ['dragenter','dragover'].forEach(t=>{
    window.addEventListener(t, e=>{
      e.preventDefault(); e.stopPropagation();
      dropZone.classList.add('dragover');
    });
  });
  ['dragleave','drop'].forEach(t=>{
    window.addEventListener(t, e=>{
      e.preventDefault(); e.stopPropagation();
      dropZone.classList.remove('dragover');
    });
  });
  window.addEventListener('drop', e=>{
    const dt = e.dataTransfer;
    if (!dt) return;
    const file = dt.files && dt.files[0];
    if (file) handleFile(file);
  });

  // Paste
  window.addEventListener('paste', async e=>{
    const items = e.clipboardData?.items || [];
    for (const it of items){
      if (it.type.startsWith('image/')){
        const blob = it.getAsFile?.();
        if (blob){ handleBlobOrFile(blob); return; }
      }
    }
    const html = e.clipboardData?.getData('text/html');
    const plain = e.clipboardData?.getData('text/plain');
    let url = null;
    if (html){
      const m = html.match(/<img[^>]+src=["']([^"']+)["']/i);
      if (m) url = m[1];
    }
    if (!url && plain && /^https?:\/\//i.test(plain)) url = plain;
    if (url){
      try{
        const res = await fetch(url, {mode:'cors'});
        const blob = await res.blob();
        if (blob.type.startsWith('image/')) handleBlobOrFile(blob);
      }catch{}
    }
  });

  // Background mode switching
  function setMode(mode){
    state.bgMode = mode;
    // Update segment active states
    const buttons = [
      {btn: modeCheckerBtn, mode: BG_MODES.CHECKER},
      {btn: modeWhiteBtn, mode: BG_MODES.WHITE},
      {btn: modeBlackBtn, mode: BG_MODES.BLACK}
    ];
    buttons.forEach(({btn, mode: btnMode})=>{
      const isActive = mode === btnMode;
      btn.setAttribute('data-state', isActive ? 'active' : 'inactive');
      btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
    });
    render();
  }
  modeCheckerBtn.addEventListener('click', ()=> setMode(BG_MODES.CHECKER));
  modeWhiteBtn  .addEventListener('click', ()=> setMode(BG_MODES.WHITE));
  modeBlackBtn  .addEventListener('click', ()=> setMode(BG_MODES.BLACK));

  // Checker controls
  cLight.addEventListener('input', ()=>{ state.light = cLight.value; render(); });
  cDark .addEventListener('input', ()=>{ state.dark  = cDark.value; render(); });
  tileSize.addEventListener('input', ()=>{
    state.size = parseInt(tileSize.value,10) || 16;
    tileLabel.textContent = state.size + 'px';
    render();
  });

  // Export
  btnDownload.addEventListener('click', async ()=>{
    if (!canvas.width || !canvas.height){ alert('请先添加图片'); return; }
    const format = 'png';
    const blob = await exportBlob({format, quality:1.0});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `composited-${canvas.width}x${canvas.height}.${format}`;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
  });

  btnCopy.addEventListener('click', async ()=>{
    if (!navigator.clipboard || !window.ClipboardItem){
      alert('当前浏览器不支持直接复制图片，请使用下载。'); return;
    }
    if (!canvas.width || !canvas.height){ alert('请先添加图片'); return; }
    const blob = await exportBlob({format:'png', quality:0.95});
    await navigator.clipboard.write([new ClipboardItem({[blob.type]: blob})]);
    alert('已复制到剪贴板');
  });

  // Init
  render();
  
  // 监听窗口大小变化，更新canvas尺寸
  let resizeTimer;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
      render();
    }, 100);
  });
</script>
</body>
</html>